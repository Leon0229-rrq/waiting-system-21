<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>じゃがバター予約</title>
<style>
  body { font-family: sans-serif; max-width: 600px; margin: 20px auto; }
  input, button { font-size: 1.2em; padding: 8px; }
  .reservation { margin-top: 20px; }
  /* 文書が改行しないように */
  .nowrap {
    white-space: nowrap;
  }
</style>
</head>
<body>

<h1>じゃがバター予約（最大3人まで）</h1>

<div id="reservation-form">
  <label>予約人数（1～3）:
    <input type="number" id="count" min="1" max="3" value="1" />
  </label>
  <button id="reserveBtn">予約する</button>
</div>

<div class="reservation" id="myReservation" style="display:none;">
  <p>受付番号: <span id="resId" class="nowrap"></span></p>
  <p>待ち人数: <span id="waitingCount" class="nowrap"></span></p>
  <p>待ち時間（分）: <span id="waitingTime" class="nowrap"></span></p>
  <button id="cancelBtn">キャンセル</button>
</div>

<div id="message"></div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwFRT6QoS5njS24txnQ82um74nV2a7ZPfKi2PKAEYh4F5mG1pevip5Q2fxoyP2KwKA/exec";

let myReservation = null;

function loadReservation() {
  const saved = localStorage.getItem("myReservation");
  if(saved) {
    myReservation = JSON.parse(saved);
  }
}

function saveReservation() {
  if(myReservation) {
    localStorage.setItem("myReservation", JSON.stringify(myReservation));
  } else {
    localStorage.removeItem("myReservation");
  }
}

async function fetchReservations() {
  try {
    const res = await fetch(GAS_URL + "?action=getReservations");
    return await res.json();
  } catch {
    return [];
  }
}

async function fetchWaitTime() {
  try {
    const res = await fetch(GAS_URL + "?action=getWaitTime");
    const data = await res.json();
    return data.waitTime || 15;
  } catch {
    return 15;
  }
}

async function updateReservationDisplay() {
  if(!myReservation) {
    document.getElementById("reservation-form").style.display = "block";
    document.getElementById("myReservation").style.display = "none";
    return;
  }
  document.getElementById("reservation-form").style.display = "none";
  document.getElementById("myReservation").style.display = "block";

  const reservations = await fetchReservations();

  let waitingCount = 0;
  reservations.forEach(r => {
    if(r.id !== myReservation.id) {
      waitingCount += r.count;
    }
  });

  const waitTimeBase = await fetchWaitTime();
  const timePerPiece = waitTimeBase / 19;
  const estimatedWait = Math.ceil(waitingCount * timePerPiece);

  document.getElementById("resId").innerText = myReservation.id;
  document.getElementById("waitingCount").innerText = waitingCount >= 0 ? waitingCount : 0;
  document.getElementById("waitingTime").innerText = estimatedWait >= 0 ? estimatedWait : 0;
}

document.getElementById("reserveBtn").addEventListener("click", async () => {
  const count = parseInt(document.getElementById("count").value);
  if(isNaN(count) || count < 1 || count > 3) {
    alert("予約人数は1～3の範囲で入力してください。");
    return;
  }
  if(myReservation) {
    alert("既に予約済みです。キャンセルしてください。");
    return;
  }
  try {
    const res = await fetch(GAS_URL + "?action=addReservation", {
      method: "POST",
      body: JSON.stringify({count}),
      headers: {"Content-Type": "application/json"}
    });
    const data = await res.json();
    if(data.status === "success") {
      myReservation = {id: data.id, count};
      saveReservation();
      await updateReservationDisplay();
    } else {
      alert(data.message || "予約に失敗しました");
    }
  } catch (e) {
    alert("通信エラーが発生しました");
  }
});

document.getElementById("cancelBtn").addEventListener("click", async () => {
  if(!myReservation) return;
  if(!confirm("キャンセルしますか？")) return;
  try {
    const res = await fetch(GAS_URL + "?action=cancelReservation", {
      method: "POST",
      body: JSON.stringify({id: myReservation.id}),
      headers: {"Content-Type": "application/json"}
    });
    const data = await res.json();
    if(data.status === "success") {
      myReservation = null;
      saveReservation();
      updateReservationDisplay();
    } else {
      alert(data.message || "キャンセルに失敗しました");
    }
  } catch (e) {
    alert("通信エラーが発生しました");
  }
});

loadReservation();
updateReservationDisplay();
</script>

</body>
</html>
